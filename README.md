# AgentCore Ã— Amplify Gen2 ãƒãƒ³ã‚ºã‚ªãƒ³

AWS Bedrock AgentCoreã‚’CDK L2ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€Amplify Gen2ã¨çµ±åˆã™ã‚‹ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã™ã€‚

## å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

- **AgentCore Runtime**: Strands Agentsã§ä½œæˆã—ãŸAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§å®Ÿè¡Œ
- **Cognitoèªè¨¼**: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ä»˜ãã§ã‚»ã‚­ãƒ¥ã‚¢ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—
- **CDK L2**: ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†
- **CodeBuildã«ã‚ˆã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ«ãƒ‰**: Codespacesã§ã‚‚é«˜é€Ÿã«ARM64ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰

---

## å‰ææ¡ä»¶

### GitHub Codespaces ã®å ´åˆï¼ˆæ¨å¥¨ï¼‰

GitHub Codespacesã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãªã—ã§ã™ãã«å§‹ã‚ã‚‰ã‚Œã¾ã™ã€‚

1. ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’Fork
2. `Code` â†’ `Create codespace on main` ã‚’ã‚¯ãƒªãƒƒã‚¯
3. CodespacesãŒèµ·å‹•ã—ãŸã‚‰æº–å‚™å®Œäº†ï¼

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®å ´åˆ

| ãƒ„ãƒ¼ãƒ« | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« |
|--------|-----------|-------------|
| Node.js | 18ä»¥ä¸Š | https://nodejs.org/ |
| AWS CLI | 2.32ä»¥ä¸Š | `brew install awscli` |
| Git | æœ€æ–° | `brew install git` |

> **Note**: Docker Desktopã¯ä¸è¦ã§ã™ã€‚Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¯AWS CodeBuildï¼ˆARM64ãƒã‚¤ãƒ†ã‚£ãƒ–ï¼‰ã§è¡Œã„ã¾ã™ã€‚

### AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

- AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã‚‹ã“ã¨
- AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã“ã¨
- Bedrockãƒ¢ãƒ‡ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆClaudeç­‰ï¼‰

---

## Step 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

### 1.1 Amplifyãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ

```bash
# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/aws-samples/amplify-vite-react-template.git my-agent-app
cd my-agent-app

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install
```

### 1.2 AgentCoreç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ 

```bash
# CDKã¨AgentCoreã®L2ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚’è¿½åŠ 
npm install @aws-cdk/aws-bedrock-agentcore-alpha@latest
npm install aws-cdk@latest aws-cdk-lib@latest

# deploy-time-build: CodeBuildã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
npm install deploy-time-build
```

---

## Step 2: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ

`amplify/agent/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚

### 2.1 Pythonã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆ

ğŸ“„ **å‚ç…§**: [`amplify/agent/app.py`](./amplify/agent/app.py)

### 2.2 ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

ğŸ“„ **å‚ç…§**: [`amplify/agent/requirements.txt`](./amplify/agent/requirements.txt)

### 2.3 Dockerfileã‚’ä½œæˆ

ğŸ“„ **å‚ç…§**: [`amplify/agent/Dockerfile`](./amplify/agent/Dockerfile)

---

## Step 3: Amplifyãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’è¨­å®š

### 3.1 ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤

```bash
# dataãƒªã‚½ãƒ¼ã‚¹ã¯ä»Šå›ä½¿ã‚ãªã„ã®ã§å‰Šé™¤
rm -rf amplify/data
```

### 3.2 AgentCoreãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ

ğŸ“„ **å‚ç…§**: [`amplify/agent/resource.ts`](./amplify/agent/resource.ts)

### 3.3 backend.tsã‚’ç·¨é›†

ğŸ“„ **å‚ç…§**: [`amplify/backend.ts`](./amplify/backend.ts)

**ãƒã‚¤ãƒ³ãƒˆ**:
- `deploy-time-build`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã€CodeBuildã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è‡ªå‹•ãƒ“ãƒ«ãƒ‰
- AgentCore CDK L2ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã§Runtimeã‚’ä½œæˆ
- Cognitoèªè¨¼ã‚’è‡ªå‹•è¨­å®š

---

## Step 4: AWSèªè¨¼

### GitHub Codespacesã®å ´åˆ

```bash
# AWS CLIã§èªè¨¼ï¼ˆIAM Identity Centerã‚’ä½¿ç”¨ï¼‰
aws configure sso

# ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã§è¨­å®šï¼ˆä¸€æ™‚èªè¨¼æƒ…å ±ï¼‰
export AWS_ACCESS_KEY_ID=AKIA...
export AWS_SECRET_ACCESS_KEY=...
export AWS_SESSION_TOKEN=...
```

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼ˆaws loginï¼‰ã®å ´åˆ

```bash
# ãƒ–ãƒ©ã‚¦ã‚¶èªè¨¼ã§CLIã«ãƒ­ã‚°ã‚¤ãƒ³
aws login
```

### èªè¨¼ç¢ºèª

```bash
# èªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
aws sts get-caller-identity
```

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¨ARNãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

---

## Step 5: CDKãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—

åˆã‚ã¦CDKã‚’ä½¿ã†ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãŒå¿…è¦ã§ã™ã€‚

```bash
# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã‚’ç¢ºèª
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

# ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—å®Ÿè¡Œ
npx cdk bootstrap aws://$ACCOUNT_ID/ap-northeast-1
```

æˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™:
- S3ãƒã‚±ãƒƒãƒˆï¼ˆCDKã‚¢ã‚»ãƒƒãƒˆç”¨ï¼‰
- ECRãƒªãƒã‚¸ãƒˆãƒªï¼ˆDockerã‚¤ãƒ¡ãƒ¼ã‚¸ç”¨ï¼‰
- IAMãƒ­ãƒ¼ãƒ«ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ï¼‰

---

## Step 6: ãƒ‡ãƒ—ãƒ­ã‚¤

### 6.1 Amplify Sandboxã§ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆDockerä¸è¦ï¼ï¼‰
AWS_REGION=ap-northeast-1 npx ampx sandbox
```

**å‡¦ç†ã®æµã‚Œ:**
1. CDKãŒã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆæˆ
2. S3ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
3. **CodeBuildãŒARM64ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰**ï¼ˆAWSä¸Šã§å®Ÿè¡Œï¼‰
4. ECRã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥
5. AgentCore Runtimeã‚’ä½œæˆ

åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯10ã€œ15åˆ†ã‹ã‹ã‚Šã¾ã™ï¼ˆCodeBuildã®ãƒ“ãƒ«ãƒ‰æ™‚é–“å«ã‚€ï¼‰ã€‚

```
âœ” Backend synthesized
âœ” Type checks completed
âœ” Built and published assets
âœ” Deployment completed
```

### 6.2 ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’ç¢ºèª

```bash
# AgentCore Runtimeã®çŠ¶æ…‹ã‚’ç¢ºèª
aws bedrock-agentcore-control list-agent-runtimes --region ap-northeast-1
```

`status: READY` ã«ãªã£ã¦ã„ã‚Œã°æˆåŠŸã§ã™ï¼

---

## Step 7: å‹•ä½œç¢ºèª

### 7.1 amplify_outputs.jsonã‚’ç¢ºèª

ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ç”Ÿæˆã•ã‚Œã‚‹ `amplify_outputs.json` ã‚’ç¢ºèª:

```bash
cat amplify_outputs.json | jq '.custom'
```

å‡ºåŠ›ä¾‹:
```json
{
  "agentRuntimeArn": "arn:aws:bedrock-agentcore:ap-northeast-1:123456789012:runtime/update_checker-xxxxx"
}
```

### 7.2 AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª

1. [Bedrock ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.aws.amazon.com/bedrock/) ã‚’é–‹ã
2. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒAgentCoreã€â†’ã€ŒRuntimesã€ã‚’é¸æŠ
3. ä½œæˆã—ãŸRuntimeãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GitHub Codespaces                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ npx ampx    â”‚                                                â”‚
â”‚  â”‚ sandbox     â”‚ â”€â”€ CDK Synth â”€â–¶                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AWS Cloud                                â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   S3     â”‚ â”€â”€â”€â–¶ â”‚ CodeBuildâ”‚ â”€â”€â”€â–¶ â”‚   ECR    â”‚              â”‚
â”‚  â”‚ (source) â”‚      â”‚ (ARM64)  â”‚      â”‚ (image)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                            â”‚                     â”‚
â”‚                                            â–¼                     â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                                     â”‚  AgentCore   â”‚            â”‚
â”‚                                     â”‚   Runtime    â”‚            â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                            â”‚                     â”‚
â”‚                                            â–¼                     â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                                     â”‚   Cognito    â”‚            â”‚
â”‚                                     â”‚    Auth      â”‚            â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãƒã‚¤ãƒ³ãƒˆ**: Dockerãƒ“ãƒ«ãƒ‰ã¯CodeBuildï¼ˆARM64ãƒã‚¤ãƒ†ã‚£ãƒ–ç’°å¢ƒï¼‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€Codespacesã®x86ç’°å¢ƒã§ã‚‚QEMUã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§é«˜é€Ÿã«ãƒ“ãƒ«ãƒ‰ã§ãã¾ã™ã€‚

---

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

ãƒãƒ³ã‚ºã‚ªãƒ³çµ‚äº†å¾Œã€ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹å ´åˆ:

```bash
# Sandboxã‚’å‰Šé™¤
AWS_REGION=ap-northeast-1 npx ampx sandbox delete

# ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ y ã‚’å…¥åŠ›
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: CodeBuild Build Failed

**åŸå› **: CodeBuildã®ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—

**è§£æ±º**:
1. AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§CodeBuildã®ãƒ­ã‚°ã‚’ç¢ºèª
2. Dockerfileã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª
3. requirements.txtã®ä¾å­˜é–¢ä¿‚ãŒæ­£ã—ã„ã‹ç¢ºèª

```bash
# CodeBuildãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’ç¢ºèª
aws codebuild list-projects --region ap-northeast-1
```

### ã‚¨ãƒ©ãƒ¼: `__dirname is not defined`

**åŸå› **: ES Moduleç’°å¢ƒã§`__dirname`ã‚’ä½¿ãŠã†ã¨ã—ã¦ã„ã‚‹

**è§£æ±º**: ä»¥ä¸‹ã‚’è¿½åŠ 

```typescript
import { fileURLToPath } from 'url';
const __dirname = path.dirname(fileURLToPath(import.meta.url));
```

### ã‚¨ãƒ©ãƒ¼: `ParameterNotFound`

**åŸå› **: CDKãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãŒæœªå®Ÿè¡Œ

**è§£æ±º**: Step 5ã®ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã‚’å®Ÿè¡Œ

### ã‚¨ãƒ©ãƒ¼: èªè¨¼ã‚¨ãƒ©ãƒ¼

**åŸå› **: AWSèªè¨¼ãŒåˆ‡ã‚Œã¦ã„ã‚‹

**è§£æ±º**: å†åº¦èªè¨¼ã‚’å®Ÿè¡Œ

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æº**: Reactã‚¢ãƒ—ãƒªã‹ã‚‰AgentCoreã‚’å‘¼ã³å‡ºã™
2. **ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«è¿½åŠ **: Strands Agentsã«ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ 
3. **æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤**: `npx ampx pipeline-deploy` ã§CI/CDæ§‹ç¯‰

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [AWS Amplify Gen2 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.amplify.aws/)
- [Amazon Bedrock AgentCore](https://docs.aws.amazon.com/bedrock/latest/userguide/agentcore.html)
- [Strands Agents](https://strandsagents.com/)
- [AWS CDK AgentCore L2](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-bedrock-agentcore-alpha-readme.html)
